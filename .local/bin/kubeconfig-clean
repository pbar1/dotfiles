#!/usr/bin/env python3

import argparse
import os
import re
from pathlib import Path
from shutil import copyfile

def clean_arns(text: str) -> str:
    return re.sub(r"arn:.*/(.*)", r"\1", text)


parser = argparse.ArgumentParser(description="Clean Kubeconfig files")
parser.add_argument(
    "--backup",
    default=True,
    help="Save a backup of the Kubeconfig file before cleaning it",
)
args = parser.parse_args()

# Find each file in the ':' delimited Kubeconfig path and apply the cleaning
# functions to each one
for kubeconfig in os.getenv("KUBECONFIG", f"{Path.home()}/.kube/config").split(":"):
    if args.backup:
        copyfile(kubeconfig, f"{kubeconfig}.backup")

    with open(kubeconfig, "r+") as file:
        text = file.read()

        clean = clean_arns(text)

        file.write(clean)
