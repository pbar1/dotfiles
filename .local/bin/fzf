#!/usr/bin/env bash

set -o errexit -o nounset -o pipefail

# Capture stdin for later use
in="$(</dev/stdin)"

# Find a copy of fzf on PATH that isn't this script
for prog in $(which -a fzf); do
  if [ "${prog}" != "${BASH_SOURCE}" ]; then
    fzf_prog="${prog}"
    break
  fi
done

# Check if we found fzf
if [[ -z "${fzf_prog}" ]]; then
  echo "fzf not found on PATH. Is it installed?" 1>&2
  exit 1
fi

# Set fzf colors based on current OS colorscheme (light/dark mode)
# Source: https://github.com/fnune/base16-fzf
# TODO: Currently only works on macOS due to dark-notify - make it generic
mode="$(dark-notify --exit)"
if [ "${mode}" = "light" ]; then
  # Base16 Solarized Light
  # Author: Ethan Schoonover (modified by aramisgithub)
  color00='#fdf6e3'
  color01='#eee8d5'
  color02='#93a1a1'
  color03='#839496'
  color04='#657b83'
  color05='#586e75'
  color06='#073642'
  color07='#002b36'
  color08='#dc322f'
  color09='#cb4b16'
  color0A='#b58900'
  color0B='#859900'
  color0C='#2aa198'
  color0D='#268bd2'
  color0E='#6c71c4'
  color0F='#d33682'
else
  # Base16 Solarized Dark
  # Author: Ethan Schoonover (modified by aramisgithub)
  color00='#002b36'
  color01='#073642'
  color02='#586e75'
  color03='#657b83'
  color04='#839496'
  color05='#93a1a1'
  color06='#eee8d5'
  color07='#fdf6e3'
  color08='#dc322f'
  color09='#cb4b16'
  color0A='#b58900'
  color0B='#859900'
  color0C='#2aa198'
  color0D='#268bd2'
  color0E='#6c71c4'
  color0F='#d33682'
fi

# Run fzf with colors specified as flags, and replay our captured stdin as input
echo "${in}" | exec "${fzf_prog}" \
  --color="bg:${color00},bg+:${color01},fg:${color04},fg+:${color06},hl:${color0D},hl+:${color0D}" \
  --color="spinner:${color0C},header:${color0D},info:${color0A},pointer:${color0C},marker:${color0C},prompt:${color0A}" \
  $@
